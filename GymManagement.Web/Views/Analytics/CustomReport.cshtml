@model GymManagement.Web.Models.DTOs.CustomReportDto

@{
    ViewData["Title"] = "Custom Report Builder - Admin";
    Layout = "_Layout";
}

@section Styles {
    <style>
        .field-item {
            transition: all 0.2s ease;
            cursor: move;
        }
        .field-item:hover {
            background-color: #f3f4f6;
        }
        .drop-zone {
            min-height: 100px;
            border: 2px dashed #d1d5db;
            transition: all 0.2s ease;
        }
        .drop-zone.drag-over {
            border-color: #3b82f6;
            background-color: #eff6ff;
        }
        .filter-row {
            background-color: #f9fafb;
            border: 1px solid #e5e7eb;
            border-radius: 0.375rem;
            padding: 1rem;
            margin-bottom: 0.5rem;
        }
        .preview-container {
            max-height: 400px;
            overflow-y: auto;
        }
    </style>
}

<div class="min-h-screen bg-gray-50 p-6">
    <!-- Header -->
    <div class="mb-8">
        <div class="flex justify-between items-center">
            <div>
                <h1 class="text-3xl font-bold text-gray-900 mb-2">‚öôÔ∏è Custom Report Builder</h1>
                <p class="text-gray-600">T·∫°o b√°o c√°o t√πy ch·ªânh v·ªõi tr√¨nh x√¢y d·ª±ng tr·ª±c quan</p>
            </div>
            <div class="flex space-x-3">
                <button onclick="saveAsTemplate()" class="px-4 py-2 border border-gray-300 rounded-md text-gray-700 hover:bg-gray-50">
                    üíæ L∆∞u template
                </button>
                <button onclick="executeReport()" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">
                    üîç Xem tr∆∞·ªõc
                </button>
                <button onclick="exportReport()" class="px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700">
                    üìä Xu·∫•t b√°o c√°o
                </button>
            </div>
        </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        <!-- Configuration Panel -->
        <div class="lg:col-span-1 space-y-6">
            <!-- Basic Info -->
            <div class="bg-white rounded-lg shadow p-6">
                <h3 class="text-lg font-semibold mb-4">üìù Th√¥ng tin c∆° b·∫£n</h3>
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">T√™n b√°o c√°o</label>
                        <input type="text" id="reportName" class="w-full border border-gray-300 rounded-md px-3 py-2" 
                               placeholder="Nh·∫≠p t√™n b√°o c√°o...">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">M√¥ t·∫£</label>
                        <textarea id="reportDescription" class="w-full border border-gray-300 rounded-md px-3 py-2" 
                                  rows="3" placeholder="M√¥ t·∫£ b√°o c√°o..."></textarea>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Lo·∫°i b√°o c√°o</label>
                        <select id="reportType" class="w-full border border-gray-300 rounded-md px-3 py-2">
                            <option value="table">üìã B·∫£ng d·ªØ li·ªáu</option>
                            <option value="chart">üìä Bi·ªÉu ƒë·ªì</option>
                            <option value="mixed">üîÄ K·∫øt h·ª£p</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- Available Fields -->
            <div class="bg-white rounded-lg shadow p-6">
                <h3 class="text-lg font-semibold mb-4">üì¶ Tr∆∞·ªùng d·ªØ li·ªáu</h3>
                <div class="space-y-2" id="availableFields">
                    <!-- Revenue Fields -->
                    <div class="field-group">
                        <h4 class="font-medium text-gray-800 mb-2">üí∞ Doanh thu</h4>
                        <div class="pl-4 space-y-1">
                            <div class="field-item p-2 rounded cursor-pointer hover:bg-gray-100" 
                                 draggable="true" data-field="revenue.date" data-type="datetime">
                                üìÖ Ng√†y thanh to√°n
                            </div>
                            <div class="field-item p-2 rounded cursor-pointer hover:bg-gray-100" 
                                 draggable="true" data-field="revenue.amount" data-type="decimal">
                                üíµ S·ªë ti·ªÅn
                            </div>
                            <div class="field-item p-2 rounded cursor-pointer hover:bg-gray-100" 
                                 draggable="true" data-field="revenue.method" data-type="string">
                                üí≥ Ph∆∞∆°ng th·ª©c
                            </div>
                        </div>
                    </div>

                    <!-- Member Fields -->
                    <div class="field-group">
                        <h4 class="font-medium text-gray-800 mb-2">üë• Th√†nh vi√™n</h4>
                        <div class="pl-4 space-y-1">
                            <div class="field-item p-2 rounded cursor-pointer hover:bg-gray-100" 
                                 draggable="true" data-field="member.name" data-type="string">
                                üë§ T√™n th√†nh vi√™n
                            </div>
                            <div class="field-item p-2 rounded cursor-pointer hover:bg-gray-100" 
                                 draggable="true" data-field="member.email" data-type="string">
                                üìß Email
                            </div>
                            <div class="field-item p-2 rounded cursor-pointer hover:bg-gray-100" 
                                 draggable="true" data-field="member.joinDate" data-type="date">
                                üìÖ Ng√†y tham gia
                            </div>
                            <div class="field-item p-2 rounded cursor-pointer hover:bg-gray-100" 
                                 draggable="true" data-field="member.status" data-type="string">
                                üîò Tr·∫°ng th√°i
                            </div>
                        </div>
                    </div>

                    <!-- Class Fields -->
                    <div class="field-group">
                        <h4 class="font-medium text-gray-800 mb-2">üéì L·ªõp h·ªçc</h4>
                        <div class="pl-4 space-y-1">
                            <div class="field-item p-2 rounded cursor-pointer hover:bg-gray-100" 
                                 draggable="true" data-field="class.name" data-type="string">
                                üìö T√™n l·ªõp h·ªçc
                            </div>
                            <div class="field-item p-2 rounded cursor-pointer hover:bg-gray-100" 
                                 draggable="true" data-field="class.trainer" data-type="string">
                                üë®‚Äçüè´ Hu·∫•n luy·ªán vi√™n
                            </div>
                            <div class="field-item p-2 rounded cursor-pointer hover:bg-gray-100" 
                                 draggable="true" data-field="class.capacity" data-type="number">
                                üë• S·ª©c ch·ª©a
                            </div>
                        </div>
                    </div>

                    <!-- Attendance Fields -->
                    <div class="field-group">
                        <h4 class="font-medium text-gray-800 mb-2">‚úÖ ƒêi·ªÉm danh</h4>
                        <div class="pl-4 space-y-1">
                            <div class="field-item p-2 rounded cursor-pointer hover:bg-gray-100" 
                                 draggable="true" data-field="attendance.date" data-type="datetime">
                                üìÖ Ng√†y ƒëi·ªÉm danh
                            </div>
                            <div class="field-item p-2 rounded cursor-pointer hover:bg-gray-100" 
                                 draggable="true" data-field="attendance.member" data-type="string">
                                üë§ Th√†nh vi√™n
                            </div>
                            <div class="field-item p-2 rounded cursor-pointer hover:bg-gray-100" 
                                 draggable="true" data-field="attendance.status" data-type="string">
                                üîò Tr·∫°ng th√°i
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Report Builder -->
        <div class="lg:col-span-2 space-y-6">
            <!-- Selected Fields -->
            <div class="bg-white rounded-lg shadow p-6">
                <h3 class="text-lg font-semibold mb-4">üìã Tr∆∞·ªùng ƒë√£ ch·ªçn</h3>
                <div class="drop-zone p-4 rounded-lg" id="selectedFields">
                    <p class="text-gray-500 text-center">K√©o th·∫£ c√°c tr∆∞·ªùng d·ªØ li·ªáu v√†o ƒë√¢y</p>
                </div>
            </div>

            <!-- Filters -->
            <div class="bg-white rounded-lg shadow p-6">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-semibold">üîç B·ªô l·ªçc</h3>
                    <button onclick="addFilter()" class="px-3 py-1 bg-blue-600 text-white rounded text-sm">
                        ‚ûï Th√™m b·ªô l·ªçc
                    </button>
                </div>
                <div id="filtersContainer">
                    <p class="text-gray-500 text-center py-4">Ch∆∞a c√≥ b·ªô l·ªçc n√†o</p>
                </div>
            </div>

            <!-- Chart Configuration -->
            <div class="bg-white rounded-lg shadow p-6" id="chartConfig" style="display: none;">
                <h3 class="text-lg font-semibold mb-4">üìä C·∫•u h√¨nh bi·ªÉu ƒë·ªì</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Lo·∫°i bi·ªÉu ƒë·ªì</label>
                        <select id="chartType" class="w-full border border-gray-300 rounded-md px-3 py-2">
                            <option value="line">üìà ƒê∆∞·ªùng</option>
                            <option value="bar">üìä C·ªôt</option>
                            <option value="pie">ü•ß Tr√≤n</option>
                            <option value="doughnut">üç© Donut</option>
                            <option value="area">üìà V√πng</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Tr·ª•c X</label>
                        <select id="xAxisField" class="w-full border border-gray-300 rounded-md px-3 py-2">
                            <option value="">Ch·ªçn tr∆∞·ªùng...</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Tr·ª•c Y</label>
                        <select id="yAxisField" class="w-full border border-gray-300 rounded-md px-3 py-2">
                            <option value="">Ch·ªçn tr∆∞·ªùng...</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Nh√≥m theo</label>
                        <select id="groupByField" class="w-full border border-gray-300 rounded-md px-3 py-2">
                            <option value="">Kh√¥ng nh√≥m</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- Preview -->
            <div class="bg-white rounded-lg shadow p-6">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-semibold">üëÅÔ∏è Xem tr∆∞·ªõc</h3>
                    <div class="flex space-x-2">
                        <button onclick="refreshPreview()" class="px-3 py-1 border border-gray-300 rounded text-sm">
                            üîÑ L√†m m·ªõi
                        </button>
                    </div>
                </div>
                <div id="previewContainer" class="preview-container">
                    <p class="text-gray-500 text-center py-8">Ch·ªçn tr∆∞·ªùng v√† nh·∫•n "Xem tr∆∞·ªõc" ƒë·ªÉ hi·ªÉn th·ªã d·ªØ li·ªáu</p>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Save Template Modal -->
<div id="saveTemplateModal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center z-50">
    <div class="bg-white rounded-lg p-6 w-full max-w-md">
        <h3 class="text-lg font-semibold mb-4">üíæ L∆∞u Template</h3>
        <div class="space-y-4">
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">T√™n template</label>
                <input type="text" id="templateName" class="w-full border border-gray-300 rounded-md px-3 py-2">
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">M√¥ t·∫£ template</label>
                <textarea id="templateDescription" class="w-full border border-gray-300 rounded-md px-3 py-2" rows="3"></textarea>
            </div>
            <div class="flex items-center">
                <input type="checkbox" id="isPublic" class="mr-2">
                <label for="isPublic" class="text-sm text-gray-700">C√¥ng khai template</label>
            </div>
        </div>
        <div class="flex justify-end space-x-3 mt-6">
            <button onclick="closeSaveTemplateModal()" class="px-4 py-2 border border-gray-300 rounded-md text-gray-700">
                H·ªßy
            </button>
            <button onclick="saveTemplate()" class="px-4 py-2 bg-blue-600 text-white rounded-md">
                L∆∞u
            </button>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        let selectedFields = [];
        let filters = [];
        let reportConfig = {};

        // Initialize drag and drop
        document.addEventListener('DOMContentLoaded', function() {
            initializeDragAndDrop();
            setupEventListeners();
        });

        function initializeDragAndDrop() {
            // Make field items draggable
            document.querySelectorAll('.field-item').forEach(item => {
                item.addEventListener('dragstart', handleDragStart);
            });

            // Setup drop zone
            const dropZone = document.getElementById('selectedFields');
            dropZone.addEventListener('dragover', handleDragOver);
            dropZone.addEventListener('drop', handleDrop);
            dropZone.addEventListener('dragenter', handleDragEnter);
            dropZone.addEventListener('dragleave', handleDragLeave);
        }

        function setupEventListeners() {
            document.getElementById('reportType').addEventListener('change', handleReportTypeChange);
        }

        function handleDragStart(e) {
            e.dataTransfer.setData('text/plain', JSON.stringify({
                field: e.target.dataset.field,
                type: e.target.dataset.type,
                label: e.target.textContent.trim()
            }));
        }

        function handleDragOver(e) {
            e.preventDefault();
        }

        function handleDragEnter(e) {
            e.preventDefault();
            e.target.classList.add('drag-over');
        }

        function handleDragLeave(e) {
            e.target.classList.remove('drag-over');
        }

        function handleDrop(e) {
            e.preventDefault();
            e.target.classList.remove('drag-over');
            
            const fieldData = JSON.parse(e.dataTransfer.getData('text/plain'));
            addSelectedField(fieldData);
        }

        function addSelectedField(fieldData) {
            // Check if field already selected
            if (selectedFields.find(f => f.field === fieldData.field)) {
                showNotification('warning', 'Tr∆∞·ªùng n√†y ƒë√£ ƒë∆∞·ª£c ch·ªçn');
                return;
            }

            selectedFields.push(fieldData);
            renderSelectedFields();
            updateChartFieldOptions();
        }

        function removeSelectedField(field) {
            selectedFields = selectedFields.filter(f => f.field !== field);
            renderSelectedFields();
            updateChartFieldOptions();
        }

        function renderSelectedFields() {
            const container = document.getElementById('selectedFields');
            
            if (selectedFields.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-center">K√©o th·∫£ c√°c tr∆∞·ªùng d·ªØ li·ªáu v√†o ƒë√¢y</p>';
                return;
            }

            container.innerHTML = selectedFields.map(field => `
                <div class="inline-flex items-center bg-blue-100 text-blue-800 rounded-full px-3 py-1 text-sm mr-2 mb-2">
                    <span>${field.label}</span>
                    <button onclick="removeSelectedField('${field.field}')" class="ml-2 text-blue-600 hover:text-blue-800">
                        ‚úï
                    </button>
                </div>
            `).join('');
        }

        function updateChartFieldOptions() {
            const xAxisSelect = document.getElementById('xAxisField');
            const yAxisSelect = document.getElementById('yAxisField');
            const groupBySelect = document.getElementById('groupByField');

            // Clear options
            [xAxisSelect, yAxisSelect, groupBySelect].forEach(select => {
                select.innerHTML = '<option value="">Ch·ªçn tr∆∞·ªùng...</option>';
            });

            // Add field options
            selectedFields.forEach(field => {
                const option = `<option value="${field.field}">${field.label}</option>`;
                xAxisSelect.innerHTML += option;
                yAxisSelect.innerHTML += option;
                groupBySelect.innerHTML += option;
            });
        }

        function handleReportTypeChange(e) {
            const chartConfig = document.getElementById('chartConfig');
            const reportType = e.target.value;
            
            if (reportType === 'chart' || reportType === 'mixed') {
                chartConfig.style.display = 'block';
            } else {
                chartConfig.style.display = 'none';
            }
        }

        function addFilter() {
            const filterId = 'filter_' + Date.now();
            const filterHtml = `
                <div class="filter-row" id="${filterId}">
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Tr∆∞·ªùng</label>
                            <select class="filter-field w-full border border-gray-300 rounded-md px-3 py-2 text-sm">
                                <option value="">Ch·ªçn tr∆∞·ªùng...</option>
                                ${selectedFields.map(f => `<option value="${f.field}">${f.label}</option>`).join('')}
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">ƒêi·ªÅu ki·ªán</label>
                            <select class="filter-operator w-full border border-gray-300 rounded-md px-3 py-2 text-sm">
                                <option value="eq">B·∫±ng</option>
                                <option value="ne">Kh√°c</option>
                                <option value="gt">L·ªõn h∆°n</option>
                                <option value="lt">Nh·ªè h∆°n</option>
                                <option value="gte">L·ªõn h∆°n ho·∫∑c b·∫±ng</option>
                                <option value="lte">Nh·ªè h∆°n ho·∫∑c b·∫±ng</option>
                                <option value="contains">Ch·ª©a</option>
                                <option value="in">Trong danh s√°ch</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Gi√° tr·ªã</label>
                            <input type="text" class="filter-value w-full border border-gray-300 rounded-md px-3 py-2 text-sm" 
                                   placeholder="Nh·∫≠p gi√° tr·ªã...">
                        </div>
                        <div class="flex items-end">
                            <button onclick="removeFilter('${filterId}')" 
                                    class="px-3 py-2 bg-red-600 text-white rounded-md text-sm hover:bg-red-700">
                                üóëÔ∏è X√≥a
                            </button>
                        </div>
                    </div>
                </div>
            `;

            const container = document.getElementById('filtersContainer');
            if (container.children.length === 1 && container.children[0].textContent.includes('Ch∆∞a c√≥ b·ªô l·ªçc')) {
                container.innerHTML = '';
            }
            container.insertAdjacentHTML('beforeend', filterHtml);
        }

        function removeFilter(filterId) {
            document.getElementById(filterId).remove();
            
            const container = document.getElementById('filtersContainer');
            if (container.children.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-center py-4">Ch∆∞a c√≥ b·ªô l·ªçc n√†o</p>';
            }
        }

        async function executeReport() {
            const config = buildReportConfig();
            
            if (!validateReportConfig(config)) {
                return;
            }

            try {
                showLoading(true);
                
                const response = await fetch('@Url.Action("ExecuteCustomReport")', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]').value
                    },
                    body: JSON.stringify(config)
                });

                const result = await response.json();
                
                if (result.success) {
                    renderPreview(result.data);
                    showNotification('success', 'B√°o c√°o ƒë√£ ƒë∆∞·ª£c t·∫°o th√†nh c√¥ng!');
                } else {
                    showNotification('error', result.message || 'C√≥ l·ªói x·∫£y ra khi t·∫°o b√°o c√°o');
                }
            } catch (error) {
                console.error('Error executing report:', error);
                showNotification('error', 'C√≥ l·ªói x·∫£y ra khi th·ª±c thi b√°o c√°o');
            } finally {
                showLoading(false);
            }
        }

        function buildReportConfig() {
            const reportType = document.getElementById('reportType').value;
            const reportName = document.getElementById('reportName').value;
            const reportDescription = document.getElementById('reportDescription').value;

            const config = {
                reportName: reportName || 'B√°o c√°o t√πy ch·ªânh',
                description: reportDescription,
                reportType: reportType,
                selectedFields: selectedFields.map(f => f.field),
                filters: [],
                sorting: [],
                chartType: document.getElementById('chartType').value,
                xAxisField: document.getElementById('xAxisField').value,
                yAxisField: document.getElementById('yAxisField').value,
                groupBy: document.getElementById('groupByField').value
            };

            // Collect filters
            document.querySelectorAll('.filter-row').forEach(row => {
                const field = row.querySelector('.filter-field').value;
                const operator = row.querySelector('.filter-operator').value;
                const value = row.querySelector('.filter-value').value;

                if (field && operator && value) {
                    config.filters.push({
                        field: field,
                        operator: operator,
                        value: value,
                        logicalOperator: 'AND'
                    });
                }
            });

            return config;
        }

        function validateReportConfig(config) {
            if (selectedFields.length === 0) {
                showNotification('warning', 'Vui l√≤ng ch·ªçn √≠t nh·∫•t m·ªôt tr∆∞·ªùng d·ªØ li·ªáu');
                return false;
            }

            if (!config.reportName.trim()) {
                showNotification('warning', 'Vui l√≤ng nh·∫≠p t√™n b√°o c√°o');
                return false;
            }

            if ((config.reportType === 'chart' || config.reportType === 'mixed') && 
                (!config.xAxisField || !config.yAxisField)) {
                showNotification('warning', 'Vui l√≤ng ch·ªçn tr·ª•c X v√† Y cho bi·ªÉu ƒë·ªì');
                return false;
            }

            return true;
        }

        function renderPreview(data) {
            const container = document.getElementById('previewContainer');
            
            if (!data || !data.data || data.data.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-center py-8">Kh√¥ng c√≥ d·ªØ li·ªáu ƒë·ªÉ hi·ªÉn th·ªã</p>';
                return;
            }

            // Render table
            const headers = Object.keys(data.data[0]);
            let tableHtml = `
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                ${headers.map(header => `<th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">${header}</th>`).join('')}
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200">
                            ${data.data.slice(0, 10).map(row => `
                                <tr>
                                    ${headers.map(header => `<td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${row[header] || ''}</td>`).join('')}
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;

            if (data.data.length > 10) {
                tableHtml += `<p class="text-sm text-gray-500 mt-4 text-center">Hi·ªÉn th·ªã 10/${data.data.length} b·∫£n ghi. Xu·∫•t b√°o c√°o ƒë·ªÉ xem ƒë·∫ßy ƒë·ªß.</p>`;
            }

            container.innerHTML = tableHtml;
        }

        function saveAsTemplate() {
            document.getElementById('saveTemplateModal').classList.remove('hidden');
        }

        function closeSaveTemplateModal() {
            document.getElementById('saveTemplateModal').classList.add('hidden');
        }

        async function saveTemplate() {
            const templateName = document.getElementById('templateName').value;
            const templateDescription = document.getElementById('templateDescription').value;
            const isPublic = document.getElementById('isPublic').checked;

            if (!templateName.trim()) {
                showNotification('warning', 'Vui l√≤ng nh·∫≠p t√™n template');
                return;
            }

            const template = {
                templateName: templateName,
                description: templateDescription,
                isPublic: isPublic,
                reportConfig: buildReportConfig()
            };

            try {
                const response = await fetch('@Url.Action("SaveReportTemplate")', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]').value
                    },
                    body: JSON.stringify(template)
                });

                const result = await response.json();
                
                if (result.success) {
                    showNotification('success', 'Template ƒë√£ ƒë∆∞·ª£c l∆∞u th√†nh c√¥ng!');
                    closeSaveTemplateModal();
                } else {
                    showNotification('error', result.message || 'C√≥ l·ªói x·∫£y ra khi l∆∞u template');
                }
            } catch (error) {
                console.error('Error saving template:', error);
                showNotification('error', 'C√≥ l·ªói x·∫£y ra khi l∆∞u template');
            }
        }

        async function exportReport() {
            const config = buildReportConfig();
            
            if (!validateReportConfig(config)) {
                return;
            }

            try {
                showLoading(true);
                
                const response = await fetch('@Url.Action("ExportReport")', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]').value
                    },
                    body: JSON.stringify({
                        customReport: config,
                        format: 'pdf'
                    })
                });

                if (response.ok) {
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `${config.reportName}_${new Date().toISOString().split('T')[0]}.pdf`;
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                    document.body.removeChild(a);
                    
                    showNotification('success', 'Xu·∫•t b√°o c√°o th√†nh c√¥ng!');
                } else {
                    const error = await response.json();
                    showNotification('error', error.message || 'C√≥ l·ªói x·∫£y ra khi xu·∫•t b√°o c√°o');
                }
            } catch (error) {
                console.error('Error exporting report:', error);
                showNotification('error', 'C√≥ l·ªói x·∫£y ra khi xu·∫•t b√°o c√°o');
            } finally {
                showLoading(false);
            }
        }

        function refreshPreview() {
            executeReport();
        }

        // Utility functions
        function showLoading(show) {
            // Implement loading indicator
            console.log('Loading:', show);
        }

        function showNotification(type, message) {
            const color = type === 'error' ? 'bg-red-500' : 
                         type === 'warning' ? 'bg-yellow-500' : 'bg-green-500';
            
            const notification = document.createElement('div');
            notification.className = `fixed top-4 right-4 ${color} text-white px-6 py-3 rounded-md shadow-lg z-50`;
            notification.textContent = message;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, 5000);
        }
    </script>
} 