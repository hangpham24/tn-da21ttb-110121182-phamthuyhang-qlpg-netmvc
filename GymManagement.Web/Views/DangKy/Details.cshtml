@model GymManagement.Web.Data.Models.DangKy
@{
    ViewData["Title"] = "Chi ti·∫øt ƒëƒÉng k√Ω";
    Layout = "_Layout";
}

<div class="p-6">
    <!-- Header -->
    <div class="flex justify-between items-center mb-8">
        <div>
            <h1 class="text-3xl font-bold text-gray-900 mb-2">üëÅÔ∏è Chi ti·∫øt ƒëƒÉng k√Ω</h1>
            <p class="text-gray-600">Th√¥ng tin chi ti·∫øt v·ªÅ ƒëƒÉng k√Ω #@Model.DangKyId</p>
        </div>
        <div class="flex gap-3">
            @if (Model.TrangThai == "ACTIVE" && User.IsInRole("Admin"))
            {
                <button type="button" onclick="showExtendModal()" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg font-medium transition-colors">
                    ‚è∞ Gia h·∫°n
                </button>
                <button type="button" onclick="showCancelModal()" class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg font-medium transition-colors">
                    ‚ùå H·ªßy ƒëƒÉng k√Ω
                </button>
            }
            <a href="@Url.Action("Index")" class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-lg font-medium transition-colors">
                ‚Üê Quay l·∫°i danh s√°ch
            </a>
        </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        <!-- Main Information -->
        <div class="lg:col-span-2 space-y-6">
            <!-- Registration Overview -->
            <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
                <h2 class="text-xl font-semibold text-gray-900 mb-4">üìã Th√¥ng tin ƒëƒÉng k√Ω</h2>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">M√£ ƒëƒÉng k√Ω</label>
                        <p class="text-lg font-semibold text-gray-900">#@Model.DangKyId</p>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Tr·∫°ng th√°i</label>
                        @switch (Model.TrangThai)
                        {
                            case "ACTIVE":
                                <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-green-100 text-green-800">
                                    ‚úÖ ƒêang ho·∫°t ƒë·ªông
                                </span>
                                break;
                            case "EXPIRED":
                                <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-red-100 text-red-800">
                                    ‚è∞ ƒê√£ h·∫øt h·∫°n
                                </span>
                                break;
                            case "CANCELLED":
                                <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-gray-100 text-gray-800">
                                    ‚ùå ƒê√£ h·ªßy
                                </span>
                                break;
                            case "PENDING":
                                <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-yellow-100 text-yellow-800">
                                    ‚è≥ Ch·ªù x·ª≠ l√Ω
                                </span>
                                break;
                            default:
                                <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-gray-100 text-gray-800">
                                    @Model.TrangThai
                                </span>
                                break;
                        }
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Ng√†y b·∫Øt ƒë·∫ßu</label>
                        <p class="text-gray-900">@Model.NgayBatDau.ToString("dd/MM/yyyy")</p>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Ng√†y k·∫øt th√∫c</label>
                        <p class="text-gray-900">@Model.NgayKetThuc.ToString("dd/MM/yyyy")</p>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Ng√†y t·∫°o</label>
                        <p class="text-gray-900">@Model.NgayTao.ToString("dd/MM/yyyy HH:mm")</p>
                    </div>
                    @if (Model.PhiDangKy.HasValue)
                    {
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Ph√≠ ƒëƒÉng k√Ω</label>
                            <p class="text-lg font-semibold text-green-600">@Model.PhiDangKy.Value.ToString("N0") VNƒê</p>
                        </div>
                    }
                </div>

                @if (!string.IsNullOrEmpty(Model.LyDoHuy))
                {
                    <div class="mt-6">
                        <label class="block text-sm font-medium text-gray-700 mb-1">L√Ω do h·ªßy</label>
                        <p class="text-gray-900 bg-gray-50 p-3 rounded-md">@Model.LyDoHuy</p>
                    </div>
                }
            </div>

            <!-- Registration Type Details -->
            @if (Model.GoiTapId.HasValue && Model.GoiTap != null)
            {
                <!-- Package Details -->
                <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
                    <h2 class="text-xl font-semibold text-gray-900 mb-4">üí≥ Th√¥ng tin g√≥i t·∫≠p</h2>
                    
                    <div class="flex items-start space-x-4">
                        <div class="flex-shrink-0">
                            <div class="w-16 h-16 bg-blue-100 rounded-lg flex items-center justify-center">
                                <span class="text-2xl">üí≥</span>
                            </div>
                        </div>
                        <div class="flex-1">
                            <h3 class="text-lg font-semibold text-gray-900 mb-2">@Model.GoiTap.TenGoi</h3>
                            <p class="text-gray-600 mb-3">@Model.GoiTap.MoTa</p>
                            
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Gi√° g√≥i</label>
                                    <p class="text-lg font-semibold text-blue-600">@Model.GoiTap.Gia.ToString("N0") VNƒê</p>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Th·ªùi h·∫°n</label>
                                    <p class="text-gray-900">@Model.GoiTap.ThoiHanThang th√°ng</p>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Tr·∫°ng th√°i g√≥i</label>
                                    <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-green-100 text-green-800">
                                        Ho·∫°t ƒë·ªông
                                    </span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            }
            else if (Model.LopHocId.HasValue && Model.LopHoc != null)
            {
                <!-- Class Details -->
                <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
                    <h2 class="text-xl font-semibold text-gray-900 mb-4">üéì Th√¥ng tin l·ªõp h·ªçc</h2>
                    
                    <div class="flex items-start space-x-4">
                        <div class="flex-shrink-0">
                            <div class="w-16 h-16 bg-green-100 rounded-lg flex items-center justify-center">
                                <span class="text-2xl">üéì</span>
                            </div>
                        </div>
                        <div class="flex-1">
                            <h3 class="text-lg font-semibold text-gray-900 mb-2">@Model.LopHoc.TenLop</h3>
                            <p class="text-gray-600 mb-3">@Model.LopHoc.MoTa</p>
                            
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Hu·∫•n luy·ªán vi√™n</label>
                                    <p class="text-gray-900">HLV ID: @Model.LopHoc.HlvId</p>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">S·ª©c ch·ª©a</label>
                                    <p class="text-gray-900">@Model.LopHoc.SucChua ng∆∞·ªùi</p>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Th·ªùi gian</label>
                                    <p class="text-gray-900">
                                        @Model.LopHoc.GioBatDau.ToString(@"hh\:mm") - @Model.LopHoc.GioKetThuc.ToString(@"hh\:mm")
                                    </p>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Tr·∫°ng th√°i l·ªõp</label>
                                    <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium @(Model.LopHoc.TrangThai == "ACTIVE" ? "bg-green-100 text-green-800" : "bg-gray-100 text-gray-800")">
                                        @Model.LopHoc.TrangThai
                                    </span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            }
        </div>

        <!-- Sidebar -->
        <div class="space-y-6">
            <!-- Member Information -->
            <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
                <h2 class="text-xl font-semibold text-gray-900 mb-4">üë§ Th√¥ng tin th√†nh vi√™n</h2>
                
                <div class="text-center mb-4">
                    @if (!string.IsNullOrEmpty(Model.NguoiDung?.AnhDaiDien))
                    {
                        <img class="w-20 h-20 rounded-full mx-auto object-cover mb-3" src="@Model.NguoiDung.AnhDaiDien" alt="Avatar">
                    }
                    else
                    {
                        <div class="w-20 h-20 rounded-full bg-gray-300 flex items-center justify-center mx-auto mb-3">
                            <span class="text-2xl font-medium text-gray-700">@(Model.NguoiDung?.Ho?.Substring(0, 1) ?? "?")</span>
                        </div>
                    }
                    <h3 class="text-lg font-semibold text-gray-900">@Model.NguoiDung?.Ho @Model.NguoiDung?.Ten</h3>
                    <p class="text-gray-500">@Model.NguoiDung?.Email</p>
                </div>

                <div class="space-y-3">
                    <div>
                        <label class="block text-sm font-medium text-gray-700">S·ªë ƒëi·ªán tho·∫°i</label>
                        <p class="text-gray-900">@Model.NguoiDung?.SoDienThoai</p>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Ng√†y sinh</label>
                        <p class="text-gray-900">@Model.NguoiDung?.NgaySinh?.ToString("dd/MM/yyyy")</p>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Gi·ªõi t√≠nh</label>
                        <p class="text-gray-900">@Model.NguoiDung?.GioiTinh</p>
                    </div>
                </div>
            </div>

            <!-- Quick Stats -->
            <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
                <h2 class="text-xl font-semibold text-gray-900 mb-4">üìä Th·ªëng k√™ nhanh</h2>
                
                <div class="space-y-4">
                    <div class="flex justify-between items-center">
                        <span class="text-gray-600">Th·ªùi gian c√≤n l·∫°i</span>
                        @{
                            var daysLeft = (Model.NgayKetThuc.ToDateTime(TimeOnly.MinValue) - DateTime.Today).Days;
                        }
                        <span class="font-semibold @(daysLeft > 7 ? "text-green-600" : daysLeft > 0 ? "text-yellow-600" : "text-red-600")">
                            @if (daysLeft > 0)
                            {
                                <text>@daysLeft ng√†y</text>
                            }
                            else if (daysLeft == 0)
                            {
                                <text>H·∫øt h·∫°n h√¥m nay</text>
                            }
                            else
                            {
                                <text>ƒê√£ h·∫øt h·∫°n @(Math.Abs(daysLeft)) ng√†y</text>
                            }
                        </span>
                    </div>
                    
                    <div class="flex justify-between items-center">
                        <span class="text-gray-600">T·ªïng th·ªùi gian</span>
                        @{
                            var totalDays = (Model.NgayKetThuc.ToDateTime(TimeOnly.MinValue) - Model.NgayBatDau.ToDateTime(TimeOnly.MinValue)).Days;
                        }
                        <span class="font-semibold text-gray-900">@totalDays ng√†y</span>
                    </div>

                    @if (Model.PhiDangKy.HasValue || (Model.GoiTap?.Gia != null))
                    {
                        <div class="flex justify-between items-center">
                            <span class="text-gray-600">Gi√° tr·ªã</span>
                            <span class="font-semibold text-blue-600">
                                @((Model.PhiDangKy ?? Model.GoiTap?.Gia ?? 0).ToString("N0")) VNƒê
                            </span>
                        </div>
                    }
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Extend Modal -->
<div id="extendModal" class="fixed inset-0 z-50 overflow-y-auto hidden" aria-labelledby="modal-title" role="dialog" aria-modal="true">
    <div class="flex items-end justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
        <div class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity" aria-hidden="true"></div>
        <span class="hidden sm:inline-block sm:align-middle sm:h-screen" aria-hidden="true">&#8203;</span>
        <div class="inline-block align-bottom bg-white rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg sm:w-full">
            <div class="bg-white px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
                <div class="sm:flex sm:items-start">
                    <div class="mx-auto flex-shrink-0 flex items-center justify-center h-12 w-12 rounded-full bg-green-100 sm:mx-0 sm:h-10 sm:w-10">
                        <svg class="h-6 w-6 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                    </div>
                    <div class="mt-3 text-center sm:mt-0 sm:ml-4 sm:text-left">
                        <h3 class="text-lg leading-6 font-medium text-gray-900">Gia h·∫°n ƒëƒÉng k√Ω</h3>
                        <div class="mt-2">
                            <p class="text-sm text-gray-500">Gia h·∫°n ƒëƒÉng k√Ω cho: <span class="font-medium">@Model.NguoiDung?.Ho @Model.NguoiDung?.Ten</span></p>
                            <div class="mt-4">
                                <label class="block text-sm font-medium text-gray-700">S·ªë th√°ng gia h·∫°n</label>
                                <input type="number" id="additionalMonths" min="1" max="12" value="1" 
                                       class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-green-500 focus:border-green-500">
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="bg-gray-50 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse">
                <button type="button" id="confirmExtend" class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-green-600 text-base font-medium text-white hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 sm:ml-3 sm:w-auto sm:text-sm">
                    Gia h·∫°n
                </button>
                <button type="button" onclick="hideExtendModal()" class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 sm:mt-0 sm:ml-3 sm:w-auto sm:text-sm">
                    H·ªßy
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Cancel Modal -->
<div id="cancelModal" class="fixed inset-0 z-50 overflow-y-auto hidden" aria-labelledby="modal-title" role="dialog" aria-modal="true">
    <div class="flex items-end justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
        <div class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity" aria-hidden="true"></div>
        <span class="hidden sm:inline-block sm:align-middle sm:h-screen" aria-hidden="true">&#8203;</span>
        <div class="inline-block align-bottom bg-white rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg sm:w-full">
            <div class="bg-white px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
                <div class="sm:flex sm:items-start">
                    <div class="mx-auto flex-shrink-0 flex items-center justify-center h-12 w-12 rounded-full bg-red-100 sm:mx-0 sm:h-10 sm:w-10">
                        <svg class="h-6 w-6 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.732 16.5c-.77.833.192 2.5 1.732 2.5z"></path>
                        </svg>
                    </div>
                    <div class="mt-3 text-center sm:mt-0 sm:ml-4 sm:text-left">
                        <h3 class="text-lg leading-6 font-medium text-gray-900">H·ªßy ƒëƒÉng k√Ω</h3>
                        <div class="mt-2">
                            <p class="text-sm text-gray-500">H·ªßy ƒëƒÉng k√Ω cho: <span class="font-medium">@Model.NguoiDung?.Ho @Model.NguoiDung?.Ten</span></p>
                            <div class="mt-4">
                                <label class="block text-sm font-medium text-gray-700">L√Ω do h·ªßy</label>
                                <textarea id="cancelReason" rows="3" 
                                          class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-red-500 focus:border-red-500"
                                          placeholder="Nh·∫≠p l√Ω do h·ªßy ƒëƒÉng k√Ω..."></textarea>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="bg-gray-50 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse">
                <button type="button" id="confirmCancel" class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-red-600 text-base font-medium text-white hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500 sm:ml-3 sm:w-auto sm:text-sm">
                    H·ªßy ƒëƒÉng k√Ω
                </button>
                <button type="button" onclick="hideCancelModal()" class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 sm:mt-0 sm:ml-3 sm:w-auto sm:text-sm">
                    ƒê√≥ng
                </button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        // Extend modal functions
        function showExtendModal() {
            document.getElementById('additionalMonths').value = 1;
            document.getElementById('extendModal').classList.remove('hidden');
        }

        function hideExtendModal() {
            document.getElementById('extendModal').classList.add('hidden');
        }

        document.getElementById('confirmExtend').addEventListener('click', function() {
            const additionalMonths = document.getElementById('additionalMonths').value;
            if (additionalMonths) {
                extendRegistration(@Model.DangKyId, additionalMonths);
            }
        });

        function extendRegistration(registrationId, additionalMonths) {
            GymApp.showLoading(document.getElementById('confirmExtend'));
            
            fetch('@Url.Action("Extend")', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                    'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]')?.value || ''
                },
                body: `id=${registrationId}&additionalMonths=${additionalMonths}`
            })
            .then(response => response.json())
            .then(data => {
                GymApp.hideLoading(document.getElementById('confirmExtend'));
                if (data.success) {
                    showNotification(data.message, 'success');
                    hideExtendModal();
                    location.reload();
                } else {
                    showNotification(data.message, 'error');
                }
            })
            .catch(error => {
                GymApp.hideLoading(document.getElementById('confirmExtend'));
                showNotification('C√≥ l·ªói x·∫£y ra khi gia h·∫°n ƒëƒÉng k√Ω.', 'error');
                console.error('Extend error:', error);
            });
        }

        // Cancel modal functions
        function showCancelModal() {
            document.getElementById('cancelReason').value = '';
            document.getElementById('cancelModal').classList.remove('hidden');
        }

        function hideCancelModal() {
            document.getElementById('cancelModal').classList.add('hidden');
        }

        document.getElementById('confirmCancel').addEventListener('click', function() {
            const reason = document.getElementById('cancelReason').value.trim();
            if (reason) {
                cancelRegistration(@Model.DangKyId, reason);
            } else {
                showNotification('Vui l√≤ng nh·∫≠p l√Ω do h·ªßy ƒëƒÉng k√Ω.', 'warning');
            }
        });

        function cancelRegistration(registrationId, reason) {
            GymApp.showLoading(document.getElementById('confirmCancel'));
            
            fetch('@Url.Action("Cancel")', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                    'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]')?.value || ''
                },
                body: `id=${registrationId}&reason=${encodeURIComponent(reason)}`
            })
            .then(response => response.json())
            .then(data => {
                GymApp.hideLoading(document.getElementById('confirmCancel'));
                if (data.success) {
                    showNotification(data.message, 'success');
                    hideCancelModal();
                    location.reload();
                } else {
                    showNotification(data.message, 'error');
                }
            })
            .catch(error => {
                GymApp.hideLoading(document.getElementById('confirmCancel'));
                showNotification('C√≥ l·ªói x·∫£y ra khi h·ªßy ƒëƒÉng k√Ω.', 'error');
                console.error('Cancel error:', error);
            });
        }
    </script>
}
