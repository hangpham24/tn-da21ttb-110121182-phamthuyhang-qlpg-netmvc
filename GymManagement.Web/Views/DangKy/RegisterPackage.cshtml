@{
    ViewData["Title"] = "ƒêƒÉng k√Ω g√≥i t·∫≠p";
    Layout = "_Layout";
}

<div class="p-6">
    <!-- Header -->
    <div class="flex justify-between items-center mb-8">
        <div>
            <h1 class="text-3xl font-bold text-gray-900 mb-2">üí≥ ƒêƒÉng k√Ω g√≥i t·∫≠p</h1>
            <p class="text-gray-600">Ch·ªçn g√≥i t·∫≠p ph√π h·ª£p v·ªõi nhu c·∫ßu c·ªßa b·∫°n</p>
        </div>
        <a href="@Url.Action("Index")" class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-lg font-medium transition-colors">
            ‚Üê Quay l·∫°i
        </a>
    </div>

    <!-- Registration Form -->
    <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
        <form asp-action="RegisterPackage" method="post" data-loading="true">
            <div asp-validation-summary="ModelOnly" class="text-red-600 mb-4"></div>

            <!-- Package Selection -->
            <div class="mb-8">
                <h2 class="text-xl font-semibold text-gray-900 mb-4">Ch·ªçn g√≥i t·∫≠p</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6" id="packageGrid">
                    @if (ViewBag.Packages != null)
                    {
                        @foreach (var package in ViewBag.Packages as IEnumerable<Microsoft.AspNetCore.Mvc.Rendering.SelectListItem>)
                        {
                            <div class="package-card border-2 border-gray-200 rounded-lg p-6 cursor-pointer hover:border-blue-300 transition-colors" 
                                 data-package-id="@package.Value" 
                                 data-package-name="@package.Text">
                                <div class="text-center">
                                    <div class="w-16 h-16 bg-blue-100 rounded-full flex items-center justify-center mx-auto mb-4">
                                        <span class="text-2xl">üí≥</span>
                                    </div>
                                    <h3 class="text-lg font-semibold text-gray-900 mb-2">@package.Text</h3>
                                    <div class="text-sm text-gray-500 mb-4">G√≥i t·∫≠p chuy√™n nghi·ªáp</div>
                                    <div class="text-2xl font-bold text-blue-600 mb-4">Li√™n h·ªá</div>
                                    <button type="button" class="w-full bg-blue-600 hover:bg-blue-700 text-white py-2 px-4 rounded-md font-medium transition-colors select-package-btn">
                                        Ch·ªçn g√≥i n√†y
                                    </button>
                                </div>
                            </div>
                        }
                    }
                </div>
                
                <!-- Hidden input for selected package -->
                <input type="hidden" name="packageId" id="selectedPackageId" required>
                <div id="packageError" class="text-red-600 text-sm mt-2 hidden">Vui l√≤ng ch·ªçn m·ªôt g√≥i t·∫≠p.</div>
            </div>

            <!-- Duration Selection -->
            <div class="mb-8" id="durationSection" style="display: none;">
                <h2 class="text-xl font-semibold text-gray-900 mb-4">Ch·ªçn th·ªùi h·∫°n</h2>
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                    <div class="duration-option border-2 border-gray-200 rounded-lg p-4 cursor-pointer hover:border-green-300 transition-colors" data-duration="1">
                        <div class="text-center">
                            <div class="text-2xl font-bold text-green-600 mb-1">1</div>
                            <div class="text-sm text-gray-600">Th√°ng</div>
                        </div>
                    </div>
                    <div class="duration-option border-2 border-gray-200 rounded-lg p-4 cursor-pointer hover:border-green-300 transition-colors" data-duration="3">
                        <div class="text-center">
                            <div class="text-2xl font-bold text-green-600 mb-1">3</div>
                            <div class="text-sm text-gray-600">Th√°ng</div>
                            <div class="text-xs text-green-600 font-medium">Ph·ªï bi·∫øn</div>
                        </div>
                    </div>
                    <div class="duration-option border-2 border-gray-200 rounded-lg p-4 cursor-pointer hover:border-green-300 transition-colors" data-duration="6">
                        <div class="text-center">
                            <div class="text-2xl font-bold text-green-600 mb-1">6</div>
                            <div class="text-sm text-gray-600">Th√°ng</div>
                            <div class="text-xs text-blue-600 font-medium">Ti·∫øt ki·ªám</div>
                        </div>
                    </div>
                    <div class="duration-option border-2 border-gray-200 rounded-lg p-4 cursor-pointer hover:border-green-300 transition-colors" data-duration="12">
                        <div class="text-center">
                            <div class="text-2xl font-bold text-green-600 mb-1">12</div>
                            <div class="text-sm text-gray-600">Th√°ng</div>
                            <div class="text-xs text-purple-600 font-medium">T·ªët nh·∫•t</div>
                        </div>
                    </div>
                </div>
                
                <!-- Hidden input for selected duration -->
                <input type="hidden" name="duration" id="selectedDuration" required>
                <div id="durationError" class="text-red-600 text-sm mt-2 hidden">Vui l√≤ng ch·ªçn th·ªùi h·∫°n.</div>
            </div>

            <!-- Promotion Code Section -->
            <div class="mb-8" id="promotionSection" style="display: none;">
                <h2 class="text-xl font-semibold text-gray-900 mb-4">üé´ M√£ khuy·∫øn m√£i (t√πy ch·ªçn)</h2>
                <div class="bg-gray-50 rounded-lg p-6">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label for="promotionCode" class="block text-sm font-medium text-gray-700 mb-2">
                                Nh·∫≠p m√£ khuy·∫øn m√£i
                            </label>
                            <div class="flex">
                                <input type="text"
                                       id="promotionCode"
                                       name="promotionCode"
                                       class="flex-1 px-3 py-2 border border-gray-300 rounded-l-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"
                                       placeholder="V√≠ d·ª•: SUMMER2024"
                                       autocomplete="off">
                                <button type="button"
                                        id="validatePromoBtn"
                                        class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-r-md font-medium transition-colors">
                                    Ki·ªÉm tra
                                </button>
                            </div>
                            <div id="promotionMessage" class="text-sm mt-2"></div>
                        </div>
                        <div id="promotionDetails" class="hidden">
                            <div class="bg-white border-2 border-green-300 rounded-lg p-4">
                                <div class="flex items-center justify-between mb-2">
                                    <span class="text-sm font-medium text-gray-700">M√£ khuy·∫øn m√£i:</span>
                                    <span class="text-sm font-bold text-green-600" id="validPromoCode"></span>
                                </div>
                                <div class="flex items-center justify-between mb-2">
                                    <span class="text-sm font-medium text-gray-700">Gi·∫£m gi√°:</span>
                                    <span class="text-sm font-bold text-green-600" id="discountPercent"></span>
                                </div>
                                <div class="flex items-center justify-between">
                                    <span class="text-sm font-medium text-gray-700">H·∫øt h·∫°n:</span>
                                    <span class="text-sm text-gray-600" id="promoExpiry"></span>
                                </div>
                                <button type="button"
                                        id="removePromoBtn"
                                        class="mt-3 w-full text-xs text-red-600 hover:text-red-800 font-medium">
                                    X√≥a m√£ khuy·∫øn m√£i
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Registration Summary -->
            <div class="mb-8" id="summarySection" style="display: none;">
                <h2 class="text-xl font-semibold text-gray-900 mb-4">T√≥m t·∫Øt ƒëƒÉng k√Ω</h2>
                <div class="bg-gray-50 rounded-lg p-6">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">G√≥i t·∫≠p ƒë√£ ch·ªçn</label>
                            <p class="text-lg font-semibold text-gray-900" id="summaryPackage">-</p>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Th·ªùi h·∫°n</label>
                            <p class="text-lg font-semibold text-gray-900" id="summaryDuration">-</p>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Ng√†y b·∫Øt ƒë·∫ßu</label>
                            <p class="text-gray-900" id="summaryStartDate">-</p>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Ng√†y k·∫øt th√∫c</label>
                            <p class="text-gray-900" id="summaryEndDate">-</p>
                        </div>
                    </div>

                    <!-- Price Summary -->
                    <div class="mt-6 pt-6 border-t border-gray-200">
                        <div class="space-y-2">
                            <div class="flex justify-between text-sm">
                                <span class="text-gray-600">Gi√° g·ªëc:</span>
                                <span class="text-gray-900" id="originalPrice">0 VNƒê</span>
                            </div>
                            <div class="flex justify-between text-sm text-green-600" id="discountRow" style="display: none;">
                                <span>Gi·∫£m gi√°:</span>
                                <span id="discountAmount">-0 VNƒê</span>
                            </div>
                            <div class="flex justify-between text-lg font-semibold border-t pt-2">
                                <span class="text-gray-900">T·ªïng thanh to√°n:</span>
                                <span class="text-blue-600" id="finalPrice">0 VNƒê</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Action Buttons -->
            <div class="flex justify-end space-x-4">
                <a href="@Url.Action("Index")" class="bg-gray-300 hover:bg-gray-400 text-gray-700 px-6 py-2 rounded-md font-medium transition-colors">
                    H·ªßy
                </a>
                <button type="submit" id="submitBtn" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-md font-medium transition-colors" disabled>
                    ‚úÖ ƒêƒÉng k√Ω g√≥i t·∫≠p
                </button>
            </div>
        </form>
    </div>
</div>

@section Scripts {
    <script>
        let selectedPackage = null;
        let selectedDuration = null;
        let appliedPromotion = null;
        let originalPrice = 0;
        let finalPrice = 0;

        // Package selection
        document.querySelectorAll('.package-card').forEach(card => {
            card.addEventListener('click', function() {
                // Remove previous selection
                document.querySelectorAll('.package-card').forEach(c => {
                    c.classList.remove('border-blue-500', 'bg-blue-50');
                    c.classList.add('border-gray-200');
                });

                // Add selection to current card
                this.classList.remove('border-gray-200');
                this.classList.add('border-blue-500', 'bg-blue-50');

                // Store selection
                selectedPackage = {
                    id: this.dataset.packageId,
                    name: this.dataset.packageName
                };

                document.getElementById('selectedPackageId').value = selectedPackage.id;
                document.getElementById('packageError').classList.add('hidden');

                // Show duration section
                document.getElementById('durationSection').style.display = 'block';

                updateSummary();
            });
        });

        // Duration selection
        document.querySelectorAll('.duration-option').forEach(option => {
            option.addEventListener('click', function() {
                // Remove previous selection
                document.querySelectorAll('.duration-option').forEach(o => {
                    o.classList.remove('border-green-500', 'bg-green-50');
                    o.classList.add('border-gray-200');
                });

                // Add selection to current option
                this.classList.remove('border-gray-200');
                this.classList.add('border-green-500', 'bg-green-50');

                // Store selection
                selectedDuration = parseInt(this.dataset.duration);
                document.getElementById('selectedDuration').value = selectedDuration;
                document.getElementById('durationError').classList.add('hidden');

                // Show promotion section
                document.getElementById('promotionSection').style.display = 'block';

                // Show summary section
                document.getElementById('summarySection').style.display = 'block';

                updateSummary();
                updateSubmitButton();
            });
        });

        function updateSummary() {
            if (selectedPackage) {
                document.getElementById('summaryPackage').textContent = selectedPackage.name;
            }

            if (selectedDuration) {
                document.getElementById('summaryDuration').textContent = selectedDuration + ' th√°ng';

                // Calculate dates
                const startDate = new Date();
                const endDate = new Date(startDate.getFullYear(), startDate.getMonth() + selectedDuration, startDate.getDate());

                document.getElementById('summaryStartDate').textContent = startDate.toLocaleDateString('vi-VN');
                document.getElementById('summaryEndDate').textContent = endDate.toLocaleDateString('vi-VN');

                // Calculate price (mock calculation - should be from server)
                originalPrice = selectedDuration * 500000; // 500k per month
                updatePriceDisplay();
            }
        }

        function updatePriceDisplay() {
            document.getElementById('originalPrice').textContent = originalPrice.toLocaleString('vi-VN') + ' VNƒê';

            if (appliedPromotion) {
                const discountAmount = originalPrice * appliedPromotion.discount / 100;
                finalPrice = originalPrice - discountAmount;

                document.getElementById('discountAmount').textContent = '-' + discountAmount.toLocaleString('vi-VN') + ' VNƒê';
                document.getElementById('discountRow').style.display = 'flex';
            } else {
                finalPrice = originalPrice;
                document.getElementById('discountRow').style.display = 'none';
            }

            document.getElementById('finalPrice').textContent = finalPrice.toLocaleString('vi-VN') + ' VNƒê';
        }

        function updateSubmitButton() {
            const submitBtn = document.getElementById('submitBtn');
            if (selectedPackage && selectedDuration) {
                submitBtn.disabled = false;
                submitBtn.classList.remove('opacity-50', 'cursor-not-allowed');
            } else {
                submitBtn.disabled = true;
                submitBtn.classList.add('opacity-50', 'cursor-not-allowed');
            }
        }

        // Form validation
        document.querySelector('form').addEventListener('submit', function(e) {
            let hasError = false;

            if (!selectedPackage) {
                document.getElementById('packageError').classList.remove('hidden');
                hasError = true;
            }

            if (!selectedDuration) {
                document.getElementById('durationError').classList.remove('hidden');
                hasError = true;
            }

            if (hasError) {
                e.preventDefault();
                showNotification('Vui l√≤ng ch·ªçn ƒë·∫ßy ƒë·ªß g√≥i t·∫≠p v√† th·ªùi h·∫°n.', 'error');
            }
        });

        // Promotion code validation
        document.getElementById('validatePromoBtn').addEventListener('click', function() {
            const promoCode = document.getElementById('promotionCode').value.trim();
            const messageDiv = document.getElementById('promotionMessage');

            if (!promoCode) {
                messageDiv.innerHTML = '<span class="text-red-600">Vui l√≤ng nh·∫≠p m√£ khuy·∫øn m√£i</span>';
                return;
            }

            // Show loading
            this.disabled = true;
            this.textContent = 'ƒêang ki·ªÉm tra...';
            messageDiv.innerHTML = '<span class="text-blue-600">ƒêang ki·ªÉm tra m√£ khuy·∫øn m√£i...</span>';

            // AJAX call to validate promotion
            fetch('@Url.Action("ValidateCode", "KhuyenMai")', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                    'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]').value
                },
                body: `code=${encodeURIComponent(promoCode)}&amount=${originalPrice}`
            })
            .then(response => response.json())
            .then(data => {
                if (data.isValid) {
                    // Valid promotion
                    appliedPromotion = {
                        code: data.promotion.maCode,
                        discount: data.promotion.phanTramGiam,
                        description: data.promotion.moTa,
                        endDate: data.promotion.ngayKetThuc
                    };

                    // Show promotion details
                    document.getElementById('validPromoCode').textContent = appliedPromotion.code;
                    document.getElementById('discountPercent').textContent = appliedPromotion.discount + '%';
                    document.getElementById('promoExpiry').textContent = appliedPromotion.endDate;
                    document.getElementById('promotionDetails').classList.remove('hidden');

                    // Hide input and show success message
                    document.getElementById('promotionCode').style.display = 'none';
                    this.style.display = 'none';
                    messageDiv.innerHTML = '<span class="text-green-600">‚úì M√£ khuy·∫øn m√£i h·ª£p l·ªá</span>';

                    // Update price display
                    updatePriceDisplay();
                } else {
                    // Invalid promotion
                    messageDiv.innerHTML = `<span class="text-red-600">‚úó ${data.errorMessage}</span>`;
                }
            })
            .catch(error => {
                console.error('Error:', error);
                messageDiv.innerHTML = '<span class="text-red-600">C√≥ l·ªói x·∫£y ra khi ki·ªÉm tra m√£ khuy·∫øn m√£i</span>';
            })
            .finally(() => {
                this.disabled = false;
                this.textContent = 'Ki·ªÉm tra';
            });
        });

        // Remove promotion
        document.getElementById('removePromoBtn').addEventListener('click', function() {
            appliedPromotion = null;

            // Reset UI
            document.getElementById('promotionCode').value = '';
            document.getElementById('promotionCode').style.display = 'block';
            document.getElementById('validatePromoBtn').style.display = 'block';
            document.getElementById('promotionDetails').classList.add('hidden');
            document.getElementById('promotionMessage').innerHTML = '';

            // Update price display
            updatePriceDisplay();
        });

        // Enter key support for promotion code
        document.getElementById('promotionCode').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                document.getElementById('validatePromoBtn').click();
            }
        });

        // Auto-select package if pre-selected from Member/Packages
        @if (ViewBag.PreSelectedPackageId != null && ViewBag.PreSelectedDuration != null)
        {
            <script>
                // Auto-select the pre-selected package
                const preSelectedPackageId = @ViewBag.PreSelectedPackageId;
                const preSelectedDuration = @ViewBag.PreSelectedDuration;
                const preSelectedPackageName = '@ViewBag.PreSelectedPackageName';
                const preSelectedPackagePrice = @(ViewBag.PreSelectedPackagePrice ?? 0);

                // Find and select the package card
                const packageCard = document.querySelector(`[data-package-id="${preSelectedPackageId}"]`);
                if (packageCard) {
                    packageCard.click();

                    // Auto-select duration
                    setTimeout(() => {
                        const durationCard = document.querySelector(`[data-duration="${preSelectedDuration}"]`);
                        if (durationCard) {
                            durationCard.click();
                        }
                    }, 100);
                }
            </script>
        }

        // Initialize
        updateSubmitButton();
    </script>
}
