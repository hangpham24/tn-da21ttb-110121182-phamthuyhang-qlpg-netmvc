@{
    ViewData["Title"] = "Thanh toán";
    Layout = "_MemberLayout";
}

<div class="min-h-screen bg-gray-50 py-8">
    <div class="max-w-3xl mx-auto px-4 sm:px-6 lg:px-8">
        <!-- Header -->
        <div class="bg-white rounded-lg shadow-sm p-6 mb-6">
            <div class="flex items-center mb-4">
                <a href="javascript:history.back()" class="text-gray-600 hover:text-gray-800 mr-4">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
                    </svg>
                </a>
                <h1 class="text-2xl font-bold text-gray-900">Thanh toán</h1>
            </div>
            <p class="text-gray-600">Hoàn tất thanh toán để kích hoạt đăng ký của bạn</p>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <!-- Payment Form -->
            <div class="lg:col-span-2">
                <div class="bg-white rounded-lg shadow-sm p-6">
                    <h2 class="text-lg font-semibold text-gray-900 mb-6">Thông tin thanh toán</h2>
                    
                    <!-- Registration Info -->
                    <div id="registrationInfo" class="bg-blue-50 rounded-lg p-4 mb-6">
                        <div class="flex items-center mb-2">
                            <svg class="w-5 h-5 text-blue-600 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                            <h3 class="font-medium text-blue-900">Thông tin đăng ký</h3>
                        </div>
                        <div id="registrationDetails" class="text-sm text-blue-800">
                            <p>Đang tải thông tin...</p>
                        </div>
                    </div>

                    <!-- Payment Methods -->
                    <div class="space-y-4">
                        <h3 class="text-md font-medium text-gray-900">Chọn phương thức thanh toán</h3>
                        
                        <!-- VNPay Option -->
                        <div class="border border-gray-200 rounded-lg p-4 hover:border-blue-300 transition-colors cursor-pointer payment-method" 
                             data-method="VNPAY" onclick="selectPaymentMethod('VNPAY')">
                            <div class="flex items-center">
                                <input type="radio" name="paymentMethod" value="VNPAY" class="text-blue-600 focus:ring-blue-500" />
                                <div class="ml-3 flex-1">
                                    <div class="flex items-center justify-between">
                                        <div>
                                            <h4 class="text-sm font-medium text-gray-900">VNPay</h4>
                                            <p class="text-sm text-gray-500">Thanh toán qua cổng VNPay (ATM, Visa, MasterCard)</p>
                                        </div>
                                        <div class="flex items-center space-x-2">
                                            <img src="https://vnpay.vn/s1/statics.vnpay.vn/2023/6/0oxhzjmxbksr1686814746087.png" 
                                                 alt="VNPay" class="h-8">
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Cash Option -->
                        <div class="border border-gray-200 rounded-lg p-4 hover:border-green-300 transition-colors cursor-pointer payment-method" 
                             data-method="CASH" onclick="selectPaymentMethod('CASH')">
                            <div class="flex items-center">
                                <input type="radio" name="paymentMethod" value="CASH" class="text-green-600 focus:ring-green-500" />
                                <div class="ml-3 flex-1">
                                    <div class="flex items-center justify-between">
                                        <div>
                                            <h4 class="text-sm font-medium text-gray-900">Tiền mặt</h4>
                                            <p class="text-sm text-gray-500">Thanh toán trực tiếp tại quầy</p>
                                        </div>
                                        <div class="flex items-center">
                                            <svg class="w-8 h-8 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 9V7a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2m2 4h10a2 2 0 002-2v-6a2 2 0 00-2-2H9a2 2 0 00-2 2v6a2 2 0 002 2zm7-5a2 2 0 11-4 0 2 2 0 014 0z"></path>
                                            </svg>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Payment Note -->
                    <div class="mt-6">
                        <label for="paymentNote" class="block text-sm font-medium text-gray-700 mb-2">
                            Ghi chú (tùy chọn)
                        </label>
                        <textarea id="paymentNote" rows="3"
                                  class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                  placeholder="Nhập ghi chú cho thanh toán (nếu có)..."></textarea>
                    </div>

                    <!-- Terms and Conditions -->
                    <div class="mt-6">
                        <label class="flex items-start">
                            <input type="checkbox" id="agreeTerms" class="mt-1 text-blue-600 focus:ring-blue-500" required />
                            <span class="ml-2 text-sm text-gray-600">
                                Tôi đồng ý với 
                                <a href="#" class="text-blue-600 hover:text-blue-800">điều khoản và điều kiện</a> 
                                của dịch vụ
                            </span>
                        </label>
                    </div>
                </div>
            </div>

            <!-- Payment Summary -->
            <div class="lg:col-span-1">
                <div class="bg-white rounded-lg shadow-sm p-6 sticky top-4">
                    <h3 class="text-lg font-semibold text-gray-900 mb-4">Tóm tắt thanh toán</h3>
                    
                    <div id="paymentSummary" class="space-y-3">
                        <div class="flex justify-between text-sm">
                            <span class="text-gray-600">Đăng ký:</span>
                            <span class="font-medium" id="summaryPackageName">-</span>
                        </div>
                        <div class="flex justify-between text-sm">
                            <span class="text-gray-600">Thành viên:</span>
                            <span class="font-medium" id="summaryMemberName">-</span>
                        </div>
                        <div class="flex justify-between text-sm">
                            <span class="text-gray-600">Thời gian:</span>
                            <span class="font-medium" id="summaryDuration">-</span>
                        </div>
                        
                        <div class="border-t border-gray-200 pt-3 mt-3">
                            <div class="flex justify-between">
                                <span class="text-base font-medium text-gray-900">Tổng cần thanh toán:</span>
                                <span class="text-xl font-bold text-green-600" id="summaryAmount">-</span>
                            </div>
                        </div>
                    </div>

                    <!-- Payment Button -->
                    <button type="button" id="paymentBtn" onclick="processPayment()" disabled
                            class="w-full mt-6 bg-blue-600 hover:bg-blue-700 disabled:bg-gray-400 disabled:cursor-not-allowed text-white px-4 py-3 rounded-md font-medium transition-colors duration-200">
                        Chọn phương thức thanh toán
                    </button>

                    <!-- Security Notice -->
                    <div class="mt-4 p-3 bg-gray-50 rounded-lg">
                        <div class="flex items-center text-sm text-gray-600">
                            <svg class="w-4 h-4 text-green-500 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"></path>
                            </svg>
                            <span>Thanh toán được bảo mật SSL</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        let selectedPaymentMethod = null;
        let registrationData = null;
        const registrationId = @ViewBag.RegistrationId;

        document.addEventListener('DOMContentLoaded', function() {
            loadRegistrationInfo();
        });

        function loadRegistrationInfo() {
            fetch(`@Url.Action("GetRegistrationInfo", "ThanhToan")?registrationId=${registrationId}`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        registrationData = data;
                        updateRegistrationDisplay(data);
                        updatePaymentSummary(data);
                    } else {
                        alert(data.message);
                        window.history.back();
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Có lỗi xảy ra khi tải thông tin đăng ký.');
                });
        }

        function updateRegistrationDisplay(data) {
            document.getElementById('registrationDetails').innerHTML = `
                <p><strong>Gói/Lớp:</strong> ${data.packageName}</p>
                <p><strong>Thành viên:</strong> ${data.memberName}</p>
                <p><strong>Thời gian:</strong> ${data.startDate} - ${data.endDate}</p>
                <p><strong>Trạng thái:</strong> ${data.status}</p>
            `;
        }

        function updatePaymentSummary(data) {
            document.getElementById('summaryPackageName').textContent = data.packageName;
            document.getElementById('summaryMemberName').textContent = data.memberName;
            document.getElementById('summaryDuration').textContent = `${data.startDate} - ${data.endDate}`;
            
            // Get amount from URL or registration data
            const urlParams = new URLSearchParams(window.location.search);
            const amount = urlParams.get('amount') || '0';
            document.getElementById('summaryAmount').textContent = new Intl.NumberFormat('vi-VN').format(amount) + ' VNĐ';
        }

        function selectPaymentMethod(method) {
            selectedPaymentMethod = method;
            
            // Update radio button
            document.querySelector(`input[value="${method}"]`).checked = true;
            
            // Update visual selection
            document.querySelectorAll('.payment-method').forEach(el => {
                el.classList.remove('border-blue-300', 'bg-blue-50', 'border-green-300', 'bg-green-50');
            });
            
            const selectedElement = document.querySelector(`[data-method="${method}"]`);
            if (method === 'VNPAY') {
                selectedElement.classList.add('border-blue-300', 'bg-blue-50');
            } else if (method === 'CASH') {
                selectedElement.classList.add('border-green-300', 'bg-green-50');
            }
            
            // Update button
            const paymentBtn = document.getElementById('paymentBtn');
            paymentBtn.disabled = false;
            paymentBtn.textContent = method === 'VNPAY' ? 'Thanh toán qua VNPay' : 'Xác nhận thanh toán tiền mặt';
        }

        function processPayment() {
            if (!selectedPaymentMethod) {
                alert('Vui lòng chọn phương thức thanh toán.');
                return;
            }

            if (!document.getElementById('agreeTerms').checked) {
                alert('Vui lòng đồng ý với điều khoản và điều kiện.');
                return;
            }

            const note = document.getElementById('paymentNote').value.trim();
            const urlParams = new URLSearchParams(window.location.search);
            const amount = urlParams.get('amount') || '0';
            
            const paymentBtn = document.getElementById('paymentBtn');
            const originalText = paymentBtn.textContent;
            paymentBtn.textContent = 'Đang xử lý...';
            paymentBtn.disabled = true;

            fetch('@Url.Action("CreatePayment", "ThanhToan")', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]')?.value || ''
                },
                body: JSON.stringify({
                    registrationId: registrationId,
                    amount: parseFloat(amount),
                    method: selectedPaymentMethod,
                    note: note
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    if (selectedPaymentMethod === 'VNPAY' && data.paymentUrl) {
                        window.location.href = data.paymentUrl;
                    } else {
                        alert(data.message);
                        // Redirect to success page or back to registrations
                        window.location.href = '@Url.Action("MyRegistrations", "Member")';
                    }
                } else {
                    alert(data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Có lỗi xảy ra khi tạo thanh toán.');
            })
            .finally(() => {
                paymentBtn.textContent = originalText;
                paymentBtn.disabled = false;
            });
        }
    </script>
} 